<!DOCTYPE html><html class="appearance-auto" lang="zh-Hans"><head><meta charset="UTF-8"><title>encrypt sqlite with sqlcipher</title><meta name="description" content="整理开发中遇到的问题与平时的一些技术积累，希望在备忘的同时能对别人有帮助"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8R1NG8CX8"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-J8R1NG8CX8');
</script><!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="##Get the sqlcipher SourceCode
123#使用2.1的版本比较稳定些https://github.com/welsonla/sqlcipher/archive/v2.1.1.tar.gz

##Complite the source code
动态链接的编译方法（Compiling with dynamic linking）[推荐]:
123./configure --enable-tempstore=yes CFLAGS=&amp;quot;-DSQLITE_HAS_CODEC&amp;quot; LDFLAGS=&amp;quot;-lcrypto&amp;quot; make ln -s /Users/wanyc/sqlcipher/sqlite3 /usr/bin/sqlcipher 
静态库的编译方法.."><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="NSLog("Life & Code");" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">welsonla's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">encrypt sqlite with sqlcipher</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile is-hidden"></div><div class="column is-9"><header class="my-4"></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">encrypt sqlite with sqlcipher</h1><time class="has-text-grey" datetime="2013-08-13T10:05:00.000Z">2013-08-13</time><article class="mt-2 post-content"><p>##Get the sqlcipher SourceCode</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用2.1的版本比较稳定些</span></span><br><span class="line"><span class="symbol">https:</span>/<span class="regexp">/github.com/welsonla</span><span class="regexp">/sqlcipher/archive</span><span class="regexp">/v2.1.1.tar.gz</span></span><br><span class="line"><span class="regexp"></span></span><br></pre></td></tr></table></figure>
<span id="more"></span>
<p>##Complite the source code<br>
动态链接的编译方法（Compiling with dynamic linking）[推荐]:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure --enable-tempstore=yes <span class="variable constant_">CFLAGS</span>=<span class="string">&quot;-DSQLITE_HAS_CODEC&quot;</span> <span class="variable constant_">LDFLAGS</span>=<span class="string">&quot;-lcrypto&quot;</span></span><br><span class="line"> make</span><br><span class="line"> ln -s /<span class="title class_">Users</span>/wanyc/sqlcipher/sqlite3 /usr/bin/sqlcipher </span><br></pre></td></tr></table></figure>
<p><s>静态库的编译方法: (replace /path/to with the path to libcrypto.a)</s></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#./configure --enable-tempstore=yes CFLAGS=&quot;-DSQLITE_HAS_CODEC&quot; LDFLAGS=&quot;/path/to/libcrypto.a&quot;</span></span><br><span class="line"><span class="comment">#make</span></span><br></pre></td></tr></table></figure>
<p>##How to encrypt a sqlite(In Shell)</p>
<p>#加密数据库几种方式</p>
<p>####1.shell方式加密一个sqlite</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqlcipher test.db</span><br><span class="line">&gt; <span class="variable constant_">PRAGMA</span> key=<span class="string">&#x27;test&#x27;</span>; <span class="regexp">//</span>必须在打开数据库第一步来执行</span><br></pre></td></tr></table></figure>
<p>####2.（In shell）</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sqlciper test.db</span><br><span class="line"><span class="variable constant_">PRAGMA</span> <span class="variable constant_">KEY</span>=<span class="string">&#x27;helloworld&#x27;</span>;<span class="comment">#第一步必须执行</span></span><br><span class="line"><span class="variable constant_">ATTACH</span> <span class="variable constant_">DATABASE</span> <span class="string">&#x27;encrypted.db&#x27;</span> as encrypted <span class="variable constant_">KEY</span> <span class="string">&#x27;SomePassword&#x27;</span>; <span class="regexp">//encrypted</span>.db是要导出的新的数据库</span><br><span class="line"><span class="variable constant_">SELECT</span> sqlcipher_export(<span class="string">&#x27;encrypted&#x27;</span>);</span><br><span class="line"><span class="variable constant_">DETACH</span> <span class="variable constant_">DATABASE</span> encrypted;</span><br></pre></td></tr></table></figure>
<p>#####3…Object-c代码实现对一个非加密库导入到加密库的方法(已经验证)(Xcode)</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">NSString</span> *documentPath = [<span class="title class_">NSSearchPathForDirectoriesInDomains</span>(<span class="title class_">NSDocumentDirectory</span>,<span class="title class_">NSUserDomainMask</span>, <span class="variable constant_">YES</span>) <span class="symbol">objectAtIndex:</span><span class="number">0</span>];</span><br><span class="line"><span class="title class_">NSString</span> *attachPath = [documentPath <span class="symbol">stringByAppendingPathComponent:</span>@<span class="string">&quot;new.db&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sqlite3_open([path_u <span class="title class_">UTF8String</span>], &amp;convert_DB) == <span class="variable constant_">SQLITE_OK</span>) &#123;</span><br><span class="line">		<span class="title class_">NSString</span> *sql = [<span class="title class_">NSString</span> <span class="symbol">stringWithFormat:</span>@<span class="string">&quot;ATTACH DATABASE &#x27;%@&#x27; AS encrypted KEY &#x27;1234&#x27;;&quot;</span>,attachPath];</span><br><span class="line">	</span><br><span class="line">		<span class="regexp">//</span>执行<span class="title class_">Attach</span>操作</span><br><span class="line">	  sqlite3_exec(convert_DB, [sql <span class="title class_">UTF8String</span>] , <span class="variable constant_">NULL</span>, <span class="variable constant_">NULL</span>, <span class="variable constant_">NULL</span>);</span><br><span class="line">  </span><br><span class="line">	  <span class="regexp">//</span> 导出数据库</span><br><span class="line">	  sqlite3_exec(convert_DB, <span class="string">&quot;SELECT sqlcipher_export(&#x27;encrypted&#x27;);&quot;</span>, <span class="variable constant_">NULL</span>, <span class="variable constant_">NULL</span>, <span class="variable constant_">NULL</span>);</span><br><span class="line">  </span><br><span class="line">	  <span class="regexp">//</span> 执行分离</span><br><span class="line">	  sqlite3_exec(convert_DB, <span class="string">&quot;DETACH DATABASE encrypted;&quot;</span>, <span class="variable constant_">NULL</span>, <span class="variable constant_">NULL</span>, <span class="variable constant_">NULL</span>);</span><br><span class="line">  </span><br><span class="line">	  <span class="title class_">NSLog</span> (@<span class="string">&quot;End database copying at %@&quot;</span>,[<span class="title class_">NSDate</span> date]);</span><br><span class="line">	  sqlite3_close(convert_DB);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    sqlite3_close(convert_DB);</span><br><span class="line">    <span class="title class_">NSAssert1</span>(<span class="variable constant_">NO</span>, @<span class="string">&quot;Failed to open database with message &#x27;%s&#x27;.&quot;</span>, sqlite3_errmsg(convert_DB));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>#为加密数据库解密<br>
####1.先导出现有库的数据(In shell)</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sqlcipher plaintext.db</span><br><span class="line">.output dsa.sql</span><br><span class="line">.dump</span><br></pre></td></tr></table></figure>
<p>####将新的数据库导出，并加密，之后导入非加密的库里面的数据</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sqlcipher another.db</span><br><span class="line"><span class="variable constant_">PRAGMA</span> key=<span class="string">&#x27;aaa&#x27;</span>;</span><br><span class="line">.read dsa.sql</span><br></pre></td></tr></table></figure>
<p>####2. 为加密后的sqlite执行解密(其实步骤与加密一样，只要把key设置为空就实现了不加密)</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">ATTACH</span> <span class="variable constant_">DATABASE</span> <span class="string">&#x27;encrypted.db&#x27;</span> as encrypted <span class="variable constant_">KEY</span> <span class="string">&#x27;&#x27;</span>; <span class="regexp">//encrypted</span>.db是要导出的新的数据库</span><br><span class="line"><span class="variable constant_">SELECT</span> sqlcipher_export(<span class="string">&#x27;encrypted&#x27;</span>);</span><br><span class="line"><span class="variable constant_">DETACH</span> <span class="variable constant_">DATABASE</span> encrypted;</span><br></pre></td></tr></table></figure>
<p>####3.（In shell）</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sqlciper test.db</span><br><span class="line"><span class="variable constant_">PRAGMA</span> <span class="variable constant_">KEY</span>=<span class="string">&#x27;helloworld&#x27;</span>;<span class="comment">#第一步必须执行</span></span><br><span class="line"><span class="variable constant_">ATTACH</span> <span class="variable constant_">DATABASE</span> <span class="string">&#x27;encrypted.db&#x27;</span> as encrypted <span class="variable constant_">KEY</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable constant_">SELECT</span> sqlcipher_export(<span class="string">&#x27;encrypted&#x27;</span>);</span><br><span class="line"><span class="variable constant_">DETACH</span> <span class="variable constant_">DATABASE</span> encrypted;</span><br></pre></td></tr></table></figure>
<p>##参考</p>
<ul>
<li>sqlcipher配置 <a target="_blank" rel="noopener" href="http://sqlcipher.net/ios-tutorial/">http://sqlcipher.net/ios-tutorial/</a></li>
<li>sqlcipher API <a target="_blank" rel="noopener" href="http://sqlcipher.net/sqlcipher-api/">http://sqlcipher.net/sqlcipher-api/</a></li>
<li>sqlcipher 使用 <a target="_blank" rel="noopener" href="http://jordy.easymorse.com/?p=970">http://jordy.easymorse.com/?p=970</a></li>
<li>Mac SQLCipher导出工具 <a target="_blank" rel="noopener" href="https://github.com/welsonla/SQLCipherExport">https://github.com/welsonla/SQLCipherExport</a></li>
</ul>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2014/01/02/my-2013/" title="我的2013"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一页: 我的2013</span></a><a class="button is-default" href="/2013/08/06/generate-new-host-rsa-key/" title="generate new host RSA key"><span class="has-text-weight-semibold">下一页: generate new host RSA key</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="Haojen/Claudia-theme-blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com/welsonla"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/welsonla"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com/welsonla_"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> welsonla 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>